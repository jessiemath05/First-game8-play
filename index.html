<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Jessie Math - 幾何工作站</title>

  <!-- ✅ 控制預覽卡片那行文字（很多平台會抓這個） -->
  <meta name="description" content="© 2025–2026 Jessie Math 捷析老師. All rights reserved.">

  <!-- ✅ LINE / FB 預覽用 -->
  <meta property="og:title" content="Jessie Math  - 幾何工作站">
  <meta property="og:description" content="© 2025–2026 Jessie Math 捷析老師. All rights reserved.">
  <meta property="og:type" content="website">

  <!-- ✅ 預覽圖片 -->
  <meta property="og:image" content="g5-u8-2.png">
  <meta property="og:image:width" content="1024">
  <meta property="og:image:height" content="1536">
  <meta property="og:image:alt" content="Jessie Math 遊戲封面">

  <!-- ✅ 有些平台會參考 -->
  <link rel="image_src" href="g5-u8-2.png">

  <!-- ✅ Twitter / X（可用同一張圖） -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Jessie Math  - 幾何工作站">
  <meta name="twitter:description" content="© 2025–2026 Jessie Math 捷析老師. All rights reserved.">
  <meta name="twitter:image" content="g5-u8-2.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Sans+TC:wght@400;600;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root {
      --bg: #f6f7fb;
      --surface: rgba(255, 255, 255, 0.72);
      --glass: rgba(255, 255, 255, 0.55);
      --glass-border: rgba(15, 23, 42, 0.12);

      --accent: #2563eb;
      --accent-glow: rgba(37, 99, 235, 0.22);

      --text: #0f172a;
      --text-muted: #64748b;

      --ok: #16a34a;
      --bad: #e11d48;

      --radius-lg: 24px;
      --radius-md: 12px;

      --hero-h: 78px;
      --pill-gray: #f3f4f6;
      --pill-gray-border: rgba(15,23,42,0.10);
      --pill-yellow: #fbbf24;
      --pill-yellow-deep: #f59e0b;
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }

    body {
      margin: 0;
      background: var(--bg);
      background-image:
        radial-gradient(1200px 600px at 10% 10%, rgba(255, 214, 165, 0.55) 0%, transparent 55%),
        radial-gradient(900px 520px at 90% 15%, rgba(186, 230, 253, 0.75) 0%, transparent 55%),
        radial-gradient(820px 520px at 75% 95%, rgba(216, 180, 254, 0.55) 0%, transparent 58%),
        radial-gradient(700px 420px at 20% 85%, rgba(167, 243, 208, 0.55) 0%, transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,0.7), rgba(255,255,255,0.2));
      background-attachment: fixed;
      color: var(--text);
      font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif;
      min-height: 100vh;
      line-height: 1.6;
    }

    /* ===== HERO ===== */
    .hero{
      position: sticky; top: 0; z-index: 100;
      height: var(--hero-h);
      display: flex; align-items: center;
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(15,23,42,0.08);
      box-shadow: 0 10px 30px rgba(15,23,42,0.05);
    }
    .hero-inner{
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 10px 18px;
      display:flex; align-items:center; justify-content:space-between;
      gap: 14px;
    }
    .brand{ display:flex; align-items:center; gap: 12px; }
    .brand-badge{
      width: 42px; height: 42px;
      border-radius: 999px;
      border: 3px solid var(--pill-yellow-deep);
      padding: 3px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(15,23,42,0.08);
      overflow:hidden;
      flex: none;
    }
    .brand-badge img{ width:100%; height:100%; object-fit:contain; border-radius: 999px; }
    .brand-title{
      font-weight: 900;
      font-size: 28px;
      letter-spacing: -0.6px;
      color: #111827;
      white-space: nowrap;
    }

    .hero-actions{
      display:flex; gap: 10px; align-items:center;
      flex-wrap: wrap; justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--pill-gray-border);
      background: var(--pill-gray);
      color: #111827;
      font-weight: 900;
      font-size: 14px;
      text-decoration:none;
      transition: .18s ease;
      white-space: nowrap;
    }
    .pill i{ color: #111827; opacity: .85; }
    .pill:hover{ transform: translateY(-1px); box-shadow: 0 12px 26px rgba(15,23,42,0.08); }

    .pill.back{
      background: var(--pill-yellow);
      border-color: rgba(245,158,11,0.55);
      color: #111827;
    }
    .pill.back i{ color: #111827; }

    /* ===== LAYOUT (RWD) ===== */
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .stack { display: grid; gap: 18px; }

    @media (max-width: 980px){
      .wrap{ padding: 18px; }
      .brand-title{ font-size: 24px; }
    }
    @media (max-width: 560px){
      :root{ --hero-h: 74px; }
      .wrap{ padding: 14px; }
      .hero-inner{ padding: 10px 12px; }
      .brand-title{ font-size: 20px; }
      .pill{ padding: 9px 14px; font-size: 13px; }
    }

    .card {
      background: var(--surface);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.06),
        0 2px 10px rgba(15, 23, 42, 0.04);
    }
    .card .hd {
      padding: 18px 22px;
      border-bottom: 1px solid var(--glass-border);
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px;
    }
    .hd h2 { margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); }
    .bd { padding: 22px; }

    @media (max-width: 560px){
      .card .hd{ padding: 16px 16px; }
      .bd{ padding: 16px; }
    }

    /* ===== HUD + BUTTONS ===== */
    .hud-row{
      display:flex;
      align-items:stretch;
      gap: 10px;
      flex-wrap: nowrap;
    }
    @media (max-width: 980px){
      .hud-row{ flex-wrap: wrap; }
    }
    .hud {
      display: flex; gap: 10px;
      flex: 1;
      min-width: 260px;
      margin: 0;
    }
    .chip {
      background: rgba(255,255,255,0.6);
      border: 1px solid var(--glass-border);
      padding: 10px 14px;
      border-radius: var(--radius-md);
      flex: 1; text-align: center;
      min-width: 0;
    }
    .chip small { display: block; font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
    .chip span { font-size: 18px; font-weight: 800; }

    .toolbar {
      display: flex;
      gap: 10px;
      margin: 0;
      flex: none;
      min-width: 210px;
    }
    .tool {
      background: rgba(255,255,255,0.6); border: 1px solid var(--glass-border);
      color: var(--text); padding: 12px 14px; border-radius: var(--radius-md);
      cursor: pointer; transition: 0.2s; font-weight: 900;
      display:flex; align-items:center; gap: 10px; justify-content:center;
      min-width: 100px;
      white-space: nowrap;
    }
    .tool:hover { border-color: var(--accent); background: var(--accent-glow); }
    .tool:disabled{ opacity: .45; cursor:not-allowed; }

    /* ===== CHALLENGE ===== */
    .figure {
      position: relative;
      background: rgba(255,255,255,0.55);
      border-radius: var(--radius-md);
      padding: 20px; border: 1px solid var(--glass-border);
      margin-bottom: 12px;
      overflow: hidden;
    }

    /* ✅ SVG 高度用 clamp 做 RWD */
    .figure svg { width: 100%; height: clamp(190px, 34vw, 260px); display:block; }

    .overlay-shapes{
      position:absolute;
      inset: 12px;
      pointer-events: none;
    }
    .overlay-shapes svg{
      width:100%;
      height: clamp(190px, 34vw, 260px);
      display:block;
    }

    #liveSvg{
      pointer-events: auto;
      cursor: grab;
      touch-action: none;
    }
    #liveSvg:active{ cursor: grabbing; }

    @media (max-width: 560px){
      .figure{ padding: 14px; }
      .overlay-shapes{ inset: 10px; }
    }

    .meta-grid { display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 20px; }
    .target-box { border-left: 2px solid var(--accent); padding-left: 16px; }
    .target-label { font-size: 12px; color: var(--text-muted); }
    .target-val { font-size: 28px; font-weight: 900; color: var(--accent); }

    @media (max-width: 560px){
      .meta-grid{ grid-template-columns: 1fr; gap: 12px; }
      .target-val{ font-size: 26px; }
    }

    /* ===== FORM ===== */
    .form { display: grid; gap: 16px; }
    .shape-card {
      background: rgba(255,255,255,0.6); border: 1px solid var(--glass-border);
      padding: 16px; border-radius: var(--radius-md);
    }
    .shape-name { font-size: 13px; font-weight: 800; margin-bottom: 12px; color: var(--accent); display: flex; align-items: center; gap: 8px; }
    .shape-name::before { content: ''; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

    .fields { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
    .field { position: relative; }
    .field label { position: absolute; top: -8px; left: 10px; background: var(--bg); padding: 0 4px; font-size: 10px; color: var(--text-muted); }
    .field input {
      width: 100%; background: rgba(255,255,255,0.65); border: 1px solid var(--glass-border);
      color: var(--text); padding: 12px; border-radius: 8px; outline: none; transition: 0.2s;
    }
    .field input:focus { border-color: var(--accent); background: rgba(255,255,255,0.9); }

    /* ===== BUTTONS ===== */
    .btn {
      border: none; padding: 14px 28px; border-radius: var(--radius-md);
      font-weight: 800; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
    }
    .btn.submit { background: var(--accent); color: #ffffff; box-shadow: 0 0 20px var(--accent-glow); }
    .btn.submit:hover { transform: scale(1.02); filter: brightness(1.05); }
    .btn.next { background: rgba(255,255,255,0.65); color: var(--text); border: 1px solid var(--glass-border); }
    .btn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* ✅ 按鈕列 RWD */
    .action-row{
      margin-top: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }
    .action-row .btns{ display:flex; gap: 12px; flex-wrap: wrap; justify-content:flex-end; }
    @media (max-width: 560px){
      .action-row{ gap: 12px; }
      .action-row .btns{ width: 100%; justify-content: space-between; }
      .btn{ padding: 12px 18px; }
    }

    /* ===== MODALS ===== */
    .overlay {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      top: 0;
      background: rgba(246, 247, 251, 0.92);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }
    #startOverlay{ top: var(--hero-h); }

    .modal {
      width: min(720px, 94%); text-align: center;
      border: 1px solid var(--glass-border); border-radius: var(--radius-lg);
      background:
        radial-gradient(circle at top, rgba(37, 99, 235, 0.18), transparent 55%),
        rgba(255,255,255,0.75);
      box-shadow:
        0 22px 60px rgba(15, 23, 42, 0.10),
        0 2px 12px rgba(15, 23, 42, 0.06);
      overflow: hidden;
    }

    .intro-body{
      padding: 18px 18px 10px;
      max-width: 920px;
      margin: 0 auto;
      text-align: left;
    }
    .intro-grid{ display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    .intro-card{
      background: rgba(255,255,255,0.72);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 16px;
    }
    .intro-card h3{ margin: 0 0 8px; font-size: 14px; letter-spacing: 1px; color: var(--text-muted); }
    .intro-card ul{ margin: 0; padding-left: 18px; color: var(--text); font-weight: 700; line-height: 1.9; }

    .input-main {
      background: rgba(255,255,255,0.7); border: 1px solid var(--glass-border);
      padding: 16px; border-radius: var(--radius-md); width: 100%;
      color: var(--text); font-size: 18px; text-align: center; margin: 18px 0 10px; outline: none;
    }
    .input-main:focus { border-color: var(--accent); background: rgba(255,255,255,0.95); }

    .intro-actions{
      display:flex; gap: 10px; justify-content: center;
      padding: 12px 18px 6px;
      max-width: 920px; margin: 0 auto;
      flex-wrap: wrap;
    }
    .intro-hint{
      max-width: 920px; margin: 0 auto;
      padding: 0 18px 18px;
      color: var(--text-muted);
      font-size: 12px;
      text-align: center;
      font-weight: 800;
    }

    /* 排行榜表格 */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { text-align: left; font-size: 11px; text-transform: uppercase; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--glass-border); }
    td { padding: 12px; border-bottom: 1px solid var(--glass-border); font-size: 14px; }
    .rank-num { font-weight: 800; color: var(--accent); }

    /* ===== FOOTER ===== */
    footer{
      max-width: 1200px;
      margin: 18px auto 24px;
      padding: 0 24px;
    }
    .footer-pill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 14px 18px;
      border-radius: 999px;
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(15,23,42,0.12);
      box-shadow: 0 18px 40px rgba(15,23,42,0.06);
      backdrop-filter: blur(10px);
      flex-wrap: wrap;
    }
    .footer-left, .footer-right{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .footer-dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--pill-yellow);
      border: 2px solid var(--pill-yellow-deep);
      box-shadow: 0 10px 18px rgba(245,158,11,0.25);
      flex: none;
    }
    .footer-copy{
      font-weight: 900;
      color: rgba(15,23,42,0.72);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 68vw;
    }
    .footer-icon{
      width: 28px; height: 28px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(37,99,235,0.12);
      border: 1px solid rgba(37,99,235,0.22);
      color: var(--accent);
      flex: none;
    }
    .footer-tagline{
      font-weight: 900;
      color: rgba(15,23,42,0.74);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 68vw;
    }
    @media (max-width: 560px){
      footer{ padding: 0 14px; }
      .footer-pill{ border-radius: 20px; }
      .footer-copy, .footer-tagline{ max-width: 78vw; }
    }
  </style>
</head>

<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <div class="brand-badge"><img src="JESSIEMATH-Q.png" alt="Jessie Math"></div>
        <div class="brand-title">Jessie Math</div>
      </div>

      <!-- ✅ HERO 右上角：與前面遊戲一致（首頁 → 遊戲大廳 → 回到五年級面積） -->
      <nav class="hero-actions" aria-label="主要導覽">
        <a class="pill" href="https://jessiemath0703-chu.github.io/website2/">
          <i class="fa-solid fa-house"></i> 首頁
        </a>
        <a class="pill" href="https://jessiemath0703-chu.github.io/Game-Lobby/">
          <i class="fa-solid fa-gamepad"></i> 遊戲大廳
        </a>
        <a class="pill back" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g5-u8">
          <i class="fa-solid fa-rotate-left"></i> 五年級面積
        </a>
      </nav>
    </div>
  </header>

  <main class="wrap" id="app">
    <div class="stack">
      <section class="card">
        <div class="hd"><h2>系統狀態</h2></div>
        <div class="bd">
          <div class="hud-row">
            <div class="hud">
              <div class="chip"><small>操作員</small><span id="hudName">—</span></div>
              <div class="chip"><small>時間</small><span id="hudTime">90</span></div>
              <div class="chip"><small>分數</small><span id="hudScore">0</span></div>
            </div>
            <div class="toolbar">
              <button class="tool" id="btnPause"><i class="fa-solid fa-pause"></i> <span id="pauseText">暫停</span></button>
              <button class="tool" id="btnBoard"><i class="fa-solid fa-trophy"></i> 排行榜</button>
            </div>
          </div>

          <div style="margin-top: 14px; font-size: 12px; color: var(--text-muted);">
            幾何工作站：輸入精確尺寸以重構目標面積。允許誤差值 &lt; 0.02。
            <span style="margin-left:10px;font-weight:900;color:rgba(15,23,42,0.72);">
              小提示：輸入哪一塊，就只顯示哪一塊；按下檢測後會自動跳下一題。
            </span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2 id="qName">載入中…</h2>
          <span style="font-size: 12px; font-weight: 800; color: var(--accent);">任務第 <span id="qIndex">1</span> 題</span>
        </div>

        <div class="bd">
          <div class="meta-grid">
            <div class="target-box">
              <div class="target-label">目標總面積</div>
              <div class="target-val" id="targetArea">—</div>
            </div>
            <div style="text-align: right;">
              <div class="target-label">結構組合</div>
              <div style="font-size: 14px; font-weight: 600;" id="allowText">—</div>
            </div>
          </div>

          <div class="figure" id="figureBox">
            <svg id="figureSvg" viewBox="0 0 560 260"></svg>
            <div class="overlay-shapes">
              <svg id="liveSvg" viewBox="0 0 560 260" aria-label="你正在輸入的形狀（可拖曳）"></svg>
            </div>
          </div>

          <div class="form" id="formArea"></div>

          <div class="action-row">
            <div id="msg" style="font-size: 14px; font-weight: 600;"></div>
            <div class="btns">
              <button class="btn next" id="btnNext" disabled>下一題</button>
              <button class="btn submit" id="btnCheck">執行檢測</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="overlay" id="startOverlay">
    <div class="modal">
      <div class="intro-body">
        <div style="font-weight: 900; font-size: 22px; letter-spacing: -0.4px; margin-top: 8px;">開始任務</div>
        <div style="color: var(--text-muted); font-size: 14px; font-weight: 800; margin-top: 6px;">
          輸入尺寸後只會顯示你正在輸入的形狀；按下檢測後，系統會自動進入下一題。
        </div>

        <div class="intro-grid">
          <div class="intro-card">
            <h3>遊戲說明</h3>
            <ul>
              <li>每題有「目標總面積」與指定組合形狀。</li>
              <li>檢測正確：直接自動下一題。</li>
              <li>檢測錯誤：系統會填入一組參考答案，然後自動下一題。</li>
              <li>允許誤差值 &lt; 0.02。</li>
            </ul>
          </div>
        </div>

        <input class="input-main" id="nameInput" type="text" placeholder="請輸入操作員代號（必填）" maxlength="16">
      </div>

      <div class="intro-actions">
        <button class="btn next" id="btnDemoName">隨機代號</button>
        <button class="btn submit" id="btnStart">進入工作站</button>
      </div>
      <div class="intro-hint">小提示：你只要負責輸。</div>
    </div>
  </div>

  <div class="overlay" id="boardModal" style="display: none;">
    <div class="modal" style="width: min(800px, 95%); text-align: left; padding: 26px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0;">排行榜</h2>
        <button class="tool" id="btnCloseBoard" style="flex: none; padding: 8px 16px;">關閉</button>
      </div>
      <div style="max-height: 400px; overflow-y: auto;">
        <table>
          <thead>
            <tr><th>名次</th><th>操作員</th><th>分數</th><th>精準度</th><th>日期</th></tr>
          </thead>
          <tbody id="boardBody"></tbody>
        </table>
      </div>
      <button id="btnClearBoard" style="background: transparent; border: none; color: var(--bad); font-size: 11px; margin-top: 20px; cursor: pointer; text-transform: uppercase;">清除所有紀錄</button>
    </div>
  </div>

  <!-- ✅ 第三：頁尾加入指定 footer -->
  <footer>
    <div class="footer-pill">
      <div class="footer-left">
        <div class="footer-dot" aria-hidden="true"></div>
        <div class="footer-copy">© 2025–2026 Jessie Math 捷析老師. All rights reserved.</div>
      </div>
      <div class="footer-right">
        <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
        <div class="footer-tagline">數學不迷路，Jessie 帶你走向理解。</div>
      </div>
    </div>
  </footer>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const nowISO = () => new Date().toISOString().slice(0,10);

    const CHALLENGES = [
      {
        id: "house", title: "結構：房屋", targetArea: 180,
        parts: [
          { type:"triangle", name:"屋頂（三角形）", fields:[{ key:"b", label:"底" }, { key:"h", label:"高" }] },
          { type:"rectangle", name:"屋身（長方形）", fields:[{ key:"w", label:"長" }, { key:"h", label:"寬" }] }
        ],
        svg: () => `<g transform="translate(80,20)">
            <polygon points="200,40 80,140 320,140" fill="none" stroke="#2563eb" stroke-width="2" />
            <rect x="100" y="140" width="200" height="110" fill="rgba(37, 99, 235, 0.10)" stroke="#2563eb" stroke-width="2"/>
          </g>`
      },
      {
        id: "kite", title: "結構：飛行器", targetArea: 216,
        parts: [
          { type:"parallelogram", name:"機身（平行四邊形）", fields:[{ key:"b", label:"底" }, { key:"h", label:"高" }] },
          { type:"triangle", name:"機翼（三角形）", fields:[{ key:"b", label:"底" }, { key:"h", label:"高" }] }
        ],
        svg: () => `<g transform="translate(70,34)">
            <polygon points="80,140 320,140 360,70 120,70" fill="none" stroke="#2563eb" stroke-width="2"/>
            <polygon points="360,70 470,105 360,140" fill="rgba(37, 99, 235, 0.10)" stroke="#2563eb" stroke-width="2"/>
          </g>`
      },
      {
        id: "garden", title: "結構：步道", targetArea: 200,
        parts: [
          { type:"square", name:"區塊（正方形）", fields:[{ key:"s", label:"邊長" }] },
          { type:"trapezoid", name:"步道（梯形）", fields:[{ key:"a", label:"上底" }, { key:"b", label:"下底" }, { key:"h", label:"高" }] }
        ],
        svg: () => `<g transform="translate(82,40)">
            <rect x="0" y="40" width="140" height="140" fill="none" stroke="#2563eb" stroke-width="2"/>
            <polygon points="180,160 440,160 400,70 220,70" fill="rgba(37, 99, 235, 0.10)" stroke="#2563eb" stroke-width="2"/>
          </g>`
      }
    ];

    const area = {
      triangle: (b,h) => (b*h)/2,
      rectangle: (w,h) => w*h,
      square: (s) => s*s,
      parallelogram: (b,h) => b*h,
      trapezoid: (a,b,h) => ((a+b)*h)/2
    };

    let playerName = "", timeLeft = 90, score = 0, correct = 0, wrong = 0, timer = null, paused = false, q = null, qCount = 0;

    /* ===== 只顯示目前正在輸入的部件 ===== */
    const LIVE = { baseX: 90, baseY: 58, maxW: 380, maxH: 170 };
    let activePartIdx = 0;
    let pieceOffsets = [];
    const dragState = { dragging:false, idx:-1, lastClientX:0, lastClientY:0 };
    let transitioning = false;

    function resetPieceOffsets(){
      pieceOffsets = (q?.parts || []).map(() => ({ x: 0, y: 0 }));
      activePartIdx = 0;
    }

    function clientDeltaToSvg(dxClient, dyClient){
      const live = $("#liveSvg");
      const rect = live.getBoundingClientRect();
      const vb = live.viewBox.baseVal;
      const sx = vb.width / rect.width;
      const sy = vb.height / rect.height;
      return { dx: dxClient * sx, dy: dyClient * sy };
    }

    function readInputsForPart(part, idx){
      const vals = {};
      let ok = true;
      part.fields.forEach(f => {
        const el = $(`#f_${idx}_${f.key}`);
        const v = parseFloat(el?.value);
        if(isNaN(v) || v <= 0) ok = false;
        vals[f.key] = v;
      });
      return { ok, vals };
    }

    function computePartDims(partType, vals){
      if(partType === "triangle") return { w: vals.b || 0, h: vals.h || 0 };
      if(partType === "rectangle") return { w: vals.w || 0, h: vals.h || 0 };
      if(partType === "square") return { w: vals.s || 0, h: vals.s || 0 };
      if(partType === "parallelogram") return { w: vals.b || 0, h: vals.h || 0 };
      if(partType === "trapezoid") return { w: Math.max(vals.a||0, vals.b||0), h: vals.h || 0, a: vals.a||0, b: vals.b||0 };
      return { w: 0, h: 0 };
    }

    function buildLiveSVG(){
      const live = $("#liveSvg");
      if(!live || !q) return;

      const part = q.parts[activePartIdx];
      if(!part){
        live.innerHTML = `<rect x="0" y="0" width="560" height="260" fill="transparent"></rect>`;
        return;
      }

      const { ok, vals } = readInputsForPart(part, activePartIdx);
      const d = computePartDims(part.type, vals);

      const maxW = Math.max(1, d.w || 1);
      const maxH = Math.max(1, d.h || 1);

      const scaleW = LIVE.maxW / maxW;
      const scaleH = LIVE.maxH / maxH;
      const s = Math.max(0.18, Math.min(2.2, Math.min(scaleW, scaleH)));

      const stroke = ok ? "#2563eb" : "rgba(225,29,72,0.55)";
      const fill = ok ? "rgba(37, 99, 235, 0.14)" : "rgba(225,29,72,0.08)";
      const dash = ok ? "" : "6 6";

      const off = pieceOffsets[activePartIdx] || { x: 0, y: 0 };

      const tag = `
        <g style="pointer-events:none;">
          <rect x="${LIVE.baseX}" y="10" width="330" height="28" rx="999"
            fill="rgba(255,255,255,0.78)" stroke="rgba(15,23,42,0.10)"/>
          <text x="${LIVE.baseX+14}" y="30" font-size="12" font-weight="900"
            fill="rgba(15,23,42,0.72)" font-family="Noto Sans TC, sans-serif">
            目前輸入：${part.name}
          </text>
        </g>
      `;

      let shape = "";
      const t = part.type;

      const gOpen = `<g class="live-piece" data-idx="${activePartIdx}" transform="translate(${off.x}, ${off.y})" style="pointer-events:auto; cursor: grab;">`;
      const gClose = `</g>`;

      if(t === "rectangle" || t === "square"){
        const w = (d.w || 1) * s;
        const h = (d.h || 1) * s;
        shape = `${gOpen}
          <rect x="${LIVE.baseX}" y="${LIVE.baseY}" width="${w}" height="${h}" rx="10"
            fill="${fill}" stroke="${stroke}" stroke-width="2" ${dash?`stroke-dasharray="${dash}"`:``} />
        ${gClose}`;
      }

      if(t === "triangle"){
        const w = (d.w || 1) * s;
        const h = (d.h || 1) * s;
        const x0 = LIVE.baseX;
        const y0 = LIVE.baseY + h;
        shape = `${gOpen}
          <polygon points="${x0},${y0} ${x0 + w},${y0} ${x0 + w/2},${LIVE.baseY}"
            fill="${fill}" stroke="${stroke}" stroke-width="2" ${dash?`stroke-dasharray="${dash}"`:``} />
        ${gClose}`;
      }

      if(t === "parallelogram"){
        const w = (d.w || 1) * s;
        const h = (d.h || 1) * s;
        const skew = Math.min(28, Math.max(10, w * 0.18));
        const x0 = LIVE.baseX;
        const y0 = LIVE.baseY;
        shape = `${gOpen}
          <polygon points="${x0+skew},${y0} ${x0+w+skew},${y0} ${x0+w},${y0+h} ${x0},${y0+h}"
            fill="${fill}" stroke="${stroke}" stroke-width="2" ${dash?`stroke-dasharray="${dash}"`:``} />
        ${gClose}`;
      }

      if(t === "trapezoid"){
        const h = (d.h || 1) * s;
        const a = (d.a || 1) * s;
        const b = (d.b || 1) * s;

        const x0 = LIVE.baseX;
        const y0 = LIVE.baseY;

        const baseW = Math.max(a, b);
        const topW = a;
        const botW = b;

        const topX = x0 + (baseW - topW)/2;
        const botX = x0 + (baseW - botW)/2;

        shape = `${gOpen}
          <polygon points="${topX},${y0} ${topX+topW},${y0} ${botX+botW},${y0+h} ${botX},${y0+h}"
            fill="${fill}" stroke="${stroke}" stroke-width="2" ${dash?`stroke-dasharray="${dash}"`:``} />
        ${gClose}`;
      }

      live.innerHTML = `
        <rect x="0" y="0" width="560" height="260" fill="transparent"></rect>
        ${tag}
        ${shape}
      `;
    }

    function initPieceDrag(){
      const live = $("#liveSvg");
      if(!live || live.dataset.pieceDragReady === "1") return;
      live.dataset.pieceDragReady = "1";

      live.addEventListener("pointerdown", (e) => {
        if(transitioning) return;
        const g = e.target.closest?.(".live-piece");
        if(!g) return;

        const idx = parseInt(g.getAttribute("data-idx"), 10);
        if(Number.isNaN(idx)) return;

        dragState.dragging = true;
        dragState.idx = idx;
        dragState.lastClientX = e.clientX;
        dragState.lastClientY = e.clientY;
        live.setPointerCapture(e.pointerId);
      });

      window.addEventListener("pointermove", (e) => {
        if(!dragState.dragging || dragState.idx < 0) return;

        const dxClient = e.clientX - dragState.lastClientX;
        const dyClient = e.clientY - dragState.lastClientY;
        dragState.lastClientX = e.clientX;
        dragState.lastClientY = e.clientY;

        const { dx, dy } = clientDeltaToSvg(dxClient, dyClient);

        const off = pieceOffsets[dragState.idx] || { x: 0, y: 0 };
        off.x += dx;
        off.y += dy;

        off.x = Math.max(-260, Math.min(260, off.x));
        off.y = Math.max(-140, Math.min(140, off.y));

        pieceOffsets[dragState.idx] = off;
        buildLiveSVG();
      });

      window.addEventListener("pointerup", () => {
        dragState.dragging = false;
        dragState.idx = -1;
      });
    }

    function bindLiveUpdate(){
      const form = $("#formArea");
      form.addEventListener("focusin", (e) => {
        const id = e.target?.id || "";
        if(!id.startsWith("f_")) return;
        const idx = parseInt(id.split("_")[1], 10);
        if(!Number.isNaN(idx)){
          activePartIdx = idx;
          buildLiveSVG();
        }
      });

      form.addEventListener("input", (e) => {
        if(!(e.target && e.target.tagName === "INPUT")) return;

        const id = e.target.id || "";
        if(id.startsWith("f_")){
          const idx = parseInt(id.split("_")[1], 10);
          if(!Number.isNaN(idx)) activePartIdx = idx;
        }
        buildLiveSVG();
      });

      buildLiveSVG();
      initPieceDrag();
    }

    function lockControls(on){
      $("#btnCheck").disabled = on;
      $("#btnPause").disabled = on;
      $("#btnBoard").disabled = on;
    }

    function rand(min, max, dp=1){
      const v = Math.random() * (max - min) + min;
      const p = Math.pow(10, dp);
      return Math.round(v * p) / p;
    }

    // ✅ 錯誤時：填入「隨便一組答案」(隨機正數) 然後下一題
    function fillRandomAnswer(){
      if(!q) return;
      q.parts.forEach((part, idx) => {
        part.fields.forEach(f => {
          const el = $(`#f_${idx}_${f.key}`);
          if(!el) return;

          // 依欄位給合理範圍（偏小更像課堂尺寸）
          let v = rand(2, 18, 1);
          if(f.key === "h") v = rand(2, 16, 1);
          if(f.key === "s") v = rand(2, 16, 1);
          if(f.key === "a" || f.key === "b") v = rand(3, 20, 1);
          if(f.key === "w") v = rand(3, 20, 1);

          el.value = v;
        });
      });
      buildLiveSVG();
    }

    function gotoNextSoon(delayMs){
      setTimeout(() => {
        if(timeLeft <= 0) return;
        loadQuestion();
        lockControls(false);
        transitioning = false;
      }, delayMs);
    }

    // ===== 啟動 / 第一頁強制輸入名字 =====
    $("#btnStart").onclick = () => {
      const n = $("#nameInput").value.trim();
      if(!n) return;
      playerName = n;
      $("#hudName").textContent = n;
      $("#startOverlay").style.display = "none";
      initGame();
    };
    $("#btnDemoName").onclick = () => { $("#nameInput").value = "操作員_" + Math.floor(Math.random()*9000 + 1000); };

    function initGame(){
      timeLeft = 90; score = 0; correct = 0; wrong = 0; qCount = 0;
      $("#hudTime").textContent = timeLeft;
      $("#hudScore").textContent = score;

      loadQuestion();

      if(timer) clearInterval(timer);
      timer = setInterval(() => {
        if(paused) return;
        timeLeft--;
        $("#hudTime").textContent = timeLeft;
        if(timeLeft <= 0) endGame();
      }, 1000);
    }

    function loadQuestion(){
      q = CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
      qCount++;
      $("#qIndex").textContent = qCount;
      $("#qName").textContent = q.title;
      $("#targetArea").textContent = q.targetArea;
      $("#allowText").textContent = q.parts.map(p => {
        const map = { triangle:"三角形", rectangle:"長方形", square:"正方形", parallelogram:"平行四邊形", trapezoid:"梯形" };
        return map[p.type] || p.type;
      }).join(" + ");
      $("#figureSvg").innerHTML = q.svg();

      resetPieceOffsets();

      $("#formArea").innerHTML = "";
      q.parts.forEach((part, idx) => {
        const card = document.createElement("div");
        card.className = "shape-card";
        card.innerHTML = `<div class="shape-name">${part.name}</div><div class="fields"></div>`;
        part.fields.forEach(f => {
          const fid = `f_${idx}_${f.key}`;
          card.querySelector(".fields").innerHTML += `
            <div class="field"><label>${f.label}</label><input id="${fid}" type="number" step="0.1"></div>`;
        });
        $("#formArea").appendChild(card);
      });

      $("#btnNext").disabled = true;     // 保留按鈕，但流程自動
      $("#btnCheck").disabled = false;
      $("#msg").textContent = "輸入尺寸後按「執行檢測」，系統會自動切換下一題。";
      $("#msg").style.color = "var(--text-muted)";

      bindLiveUpdate();
    }

    // ✅ 第一：正確自動下一題；錯誤給一組答案後自動下一題
    $("#btnCheck").onclick = () => {
      if(paused || transitioning) return;

      let total = 0;
      let valid = true;

      q.parts.forEach((part, idx) => {
        const vals = {};
        part.fields.forEach(f => {
          const v = parseFloat($(`#f_${idx}_${f.key}`).value);
          if(isNaN(v) || v <= 0) valid = false;
          vals[f.key] = v;
        });

        if(part.type === "triangle") total += area.triangle(vals.b, vals.h);
        if(part.type === "rectangle") total += area.rectangle(vals.w, vals.h);
        if(part.type === "square") total += area.square(vals.s);
        if(part.type === "parallelogram") total += area.parallelogram(vals.b, vals.h);
        if(part.type === "trapezoid") total += area.trapezoid(vals.a, vals.b, vals.h);
      });

      if(!valid){
        $("#msg").textContent = "尺寸有問題：請輸入大於 0 的數值。";
        $("#msg").style.color = "var(--bad)";
        return;
      }

      transitioning = true;
      lockControls(true);

      const diff = total - q.targetArea;

      if(Math.abs(diff) < 0.02){
        score += 10; correct++; timeLeft += 5;
        $("#hudScore").textContent = score;
        $("#hudTime").textContent = timeLeft;

        $("#msg").textContent = `正確！總面積 ${total.toFixed(2)} 命中目標。自動下一題…`;
        $("#msg").style.color = "var(--ok)";

        gotoNextSoon(650);
      } else {
        score -= 5; wrong++; timeLeft -= 5;
        $("#hudScore").textContent = score;
        $("#hudTime").textContent = timeLeft;

        // 先填入隨機答案，再下一題
        fillRandomAnswer();

        $("#msg").textContent = `錯誤！你的總面積 ${total.toFixed(2)}（差值 ${diff.toFixed(2)}）。已提供一組參考答案，下一題…`;
        $("#msg").style.color = "var(--bad)";

        gotoNextSoon(900);
      }
    };

    // 保留但不主動用
    $("#btnNext").onclick = loadQuestion;

    $("#btnPause").onclick = () => {
      if(transitioning) return;
      paused = !paused;
      $("#pauseText").textContent = paused ? "繼續" : "暫停";
    };

    function endGame(){
      clearInterval(timer);
      const list = JSON.parse(localStorage.getItem("JM_FUTURE_BOARD") || "[]");
      list.push({ name: playerName, score, correct, date: nowISO() });
      list.sort((a,b) => b.score - a.score);
      localStorage.setItem("JM_FUTURE_BOARD", JSON.stringify(list.slice(0, 10)));
      openBoard();
    }

    function openBoard(){
      const list = JSON.parse(localStorage.getItem("JM_FUTURE_BOARD") || "[]");
      $("#boardBody").innerHTML = list.map((r, i) => `
        <tr>
          <td class="rank-num">#${i+1}</td>
          <td>${r.name}</td>
          <td>${r.score}</td>
          <td>${r.correct} 次成功</td>
          <td style="color: var(--text-muted); font-size: 11px;">${r.date}</td>
        </tr>`).join("");
      $("#boardModal").style.display = "flex";
    }

    $("#btnBoard").onclick = openBoard;
    $("#btnCloseBoard").onclick = () => $("#boardModal").style.display = "none";
    $("#btnClearBoard").onclick = () => { localStorage.removeItem("JM_FUTURE_BOARD"); openBoard(); };
  </script>
</body>
</html>

